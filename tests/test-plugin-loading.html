<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Datastar Plugin Loading Test</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      line-height: 1.6;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
    }

    .container {
      background: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
    }

    h1 {
      color: #2563eb;
      border-bottom: 3px solid #2563eb;
      padding-bottom: 10px;
      margin-bottom: 30px;
    }

    h2 {
      color: #1e40af;
      margin-top: 40px;
      margin-bottom: 20px;
      padding-left: 10px;
      border-left: 4px solid #3b82f6;
    }

    .status {
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      font-weight: 500;
    }

    .success {
      background: #dcfce7;
      color: #166534;
      border-left: 4px solid #22c55e;
    }

    .warning {
      background: #fef3c7;
      color: #a16207;
      border-left: 4px solid #f59e0b;
    }

    .error {
      background: #fecaca;
      color: #dc2626;
      border-left: 4px solid #ef4444;
    }

    .info {
      background: #dbeafe;
      color: #1d4ed8;
      border-left: 4px solid #3b82f6;
    }

    .debug-info {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      padding: 15px;
      margin: 15px 0;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      max-height: 200px;
      overflow-y: auto;
      white-space: pre-wrap;
    }

    .test-section {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
    }

    .test-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin: 20px 0;
    }

    button {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
    }

    button:hover {
      background: #2563eb;
      transform: translateY(-1px);
    }

    button:disabled {
      background: #9ca3af;
      cursor: not-allowed;
      transform: none;
    }

    .tooltip {
      background: #1f2937;
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 14px;
      white-space: nowrap;
      opacity: 0;
      transition: opacity 0.2s;
      pointer-events: none;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }

    .tooltip.visible {
      opacity: 1;
    }

    .plugin-status {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 10px 0;
    }

    .status-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      display: inline-block;
    }

    .status-indicator.loaded {
      background: #22c55e;
    }

    .status-indicator.loading {
      background: #f59e0b;
      animation: pulse 1s infinite;
    }

    .status-indicator.error {
      background: #ef4444;
    }

    .status-indicator.pending {
      background: #9ca3af;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .feature-demo {
      border: 2px dashed #e2e8f0;
      border-radius: 8px;
      padding: 20px;
      margin: 15px 0;
      text-align: center;
    }

    .feature-demo.active {
      border-color: #22c55e;
      background: #f0fdf4;
    }

    code {
      background: #f1f5f9;
      padding: 2px 6px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
    }

    .api-examples {
      background: #f8fafc;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
    }

    .example-code {
      background: #1e293b;
      color: #f1f5f9;
      padding: 15px;
      border-radius: 6px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      overflow-x: auto;
      margin: 10px 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üöÄ Datastar Plugin Loading System Test</h1>
    <p>This test validates the dynamic plugin loading system for Datastar plugins without requiring manual downloads.</p>

    <!-- Loading Status -->
    <div id="loading-status">
      <h2>üì¶ System Status</h2>
      <div class="debug-info" id="debug-output">Initializing plugin loading system...</div>
      
      <div class="plugin-status">
        <span class="status-indicator pending" id="datastar-indicator"></span>
        <span>Datastar Core</span>
      </div>
      
      <div class="plugin-status">
        <span class="status-indicator pending" id="loader-indicator"></span>
        <span>Plugin Loader</span>
      </div>
      
      <div class="plugin-status">
        <span class="status-indicator pending" id="anchor-indicator"></span>
        <span>Anchor Plugin</span>
      </div>
    </div>

    <!-- Manual Loading Tests -->
    <div class="test-section">
      <h2>üîß Manual Plugin Loading</h2>
      <p>Test different ways of loading plugins programmatically:</p>
      
      <div class="test-buttons">
        <button id="load-anchor-btn" onclick="loadAnchorPlugin()">Load Anchor Plugin</button>
        <button id="load-multiple-btn" onclick="loadMultiplePlugins()">Load Multiple Plugins</button>
        <button id="auto-load-btn" onclick="autoLoadPlugins()">Auto-Load from DOM</button>
        <button id="unload-btn" onclick="unloadPlugin()">Unload Plugin</button>
      </div>

      <div class="debug-info" id="manual-debug">Manual loading results will appear here...</div>
    </div>

    <!-- Auto-Discovery Test -->
    <div class="test-section">
      <h2>üîç Auto-Discovery Test</h2>
      <p>These elements should trigger automatic plugin loading when <code>autoLoadPlugins()</code> is called:</p>
      
      <div class="feature-demo" id="auto-discovery-demo">
        <button id="anchor-test-btn" 
                data-on-mouseenter="$showTooltip = true"
                data-on-mouseleave="$showTooltip = false">
          Hover for Tooltip
        </button>
        
        <!-- This should trigger anchor plugin auto-loading -->
        <div data-anchor-top="'#anchor-test-btn'" 
             data-show="$showTooltip"
             class="tooltip">
          Auto-discovered anchor positioning!
        </div>
      </div>
    </div>

    <!-- Plugin Functionality Demo -->
    <div class="test-section">
      <h2>‚ö° Plugin Functionality Demo</h2>
      <p>Test that loaded plugins work correctly:</p>
      
      <div class="test-buttons">
        <button id="demo-btn-1">Top Tooltip</button>
        <button id="demo-btn-2">Bottom Tooltip</button>
        <button id="demo-btn-3">Left Tooltip</button>
        <button id="demo-btn-4">Right Tooltip</button>
      </div>

      <!-- Tooltip elements that should be positioned by the anchor plugin -->
      <div data-anchor-top="'#demo-btn-1'" 
           data-show="$tooltip1"
           class="tooltip">
        Top positioned tooltip
      </div>
      
      <div data-anchor-bottom="'#demo-btn-2'" 
           data-show="$tooltip2"
           class="tooltip">
        Bottom positioned tooltip
      </div>
      
      <div data-anchor-left="'#demo-btn-3'" 
           data-show="$tooltip3"
           class="tooltip">
        Left positioned tooltip
      </div>
      
      <div data-anchor-right="'#demo-btn-4'" 
           data-show="$tooltip4"
           class="tooltip">
        Right positioned tooltip
      </div>
    </div>

    <!-- API Examples -->
    <div class="api-examples">
      <h2>üìö API Usage Examples</h2>
      
      <h3>Basic Plugin Loading</h3>
      <div class="example-code">// Load single plugin
await datastar.loadPlugin('anchor');

// Load with specific version
await datastar.loadPlugin('anchor', { version: '1.0.0' });

// Load multiple plugins
await datastar.loadPlugins(['anchor', 'tooltip']);
      </div>

      <h3>Auto-Discovery</h3>
      <div class="example-code">// Scan DOM and load required plugins automatically
await datastar.autoLoadPlugins();

// Check what's loaded
console.log(datastar.getLoadedPlugins());
      </div>

      <h3>Advanced Options</h3>
      <div class="example-code">// Load with custom CDN and timeout
await datastar.loadPlugin('anchor', {
  cdn: 'https://my-cdn.com',
  timeout: 5000,
  fallback: '/local/anchor.js'
});
      </div>
    </div>

    <!-- Plugin Information -->
    <div id="plugin-info">
      <h2>üìä Loaded Plugin Information</h2>
      <div class="debug-info" id="plugin-list">No plugins loaded yet...</div>
    </div>
  </div>

  <!-- Load Datastar Core -->
  <script src="https://cdn.jsdelivr.net/npm/@starfederation/datastar@1.0.0-beta.1/dist/datastar.js"></script>
  
  <!-- Load Plugin Loader -->
  <script src="/dist/plugin-loader-browser.js"></script>

  <script>
    // Global state for demo
    let debugOutput = document.getElementById('debug-output');
    let manualDebug = document.getElementById('manual-debug');
    let pluginList = document.getElementById('plugin-list');

    function log(message, target = 'debug') {
      const timestamp = new Date().toLocaleTimeString();
      const logMessage = `[${timestamp}] ${message}`;
      console.log(logMessage);
      
      if (target === 'manual') {
        manualDebug.textContent += logMessage + '\n';
        manualDebug.scrollTop = manualDebug.scrollHeight;
      } else {
        debugOutput.textContent += logMessage + '\n';
        debugOutput.scrollTop = debugOutput.scrollHeight;
      }
    }

    function updateIndicator(id, status) {
      const indicator = document.getElementById(id);
      indicator.className = `status-indicator ${status}`;
    }

    function updatePluginList() {
      if (window.datastar && window.datastar.getLoadedPlugins) {
        const plugins = window.datastar.getLoadedPlugins();
        if (plugins.length > 0) {
          const pluginInfo = plugins.map(p => 
            `${p.name}@${p.version} - ${p.loaded ? '‚úÖ Loaded' : '‚ùå Failed'}`
          ).join('\n');
          pluginList.textContent = pluginInfo;
        } else {
          pluginList.textContent = 'No plugins loaded yet...';
        }
      }
    }

    // Test Functions
    async function loadAnchorPlugin() {
      try {
        log('Loading anchor plugin...', 'manual');
        updateIndicator('anchor-indicator', 'loading');
        
        const plugin = await window.datastar.loadPlugin('anchor');
        log('‚úÖ Anchor plugin loaded successfully!', 'manual');
        updateIndicator('anchor-indicator', 'loaded');
        updatePluginList();
        
        // Enable functionality demos
        enableFunctionalityDemo();
        
      } catch (error) {
        log(`‚ùå Failed to load anchor plugin: ${error.message}`, 'manual');
        updateIndicator('anchor-indicator', 'error');
      }
    }

    async function loadMultiplePlugins() {
      try {
        log('Loading multiple plugins...', 'manual');
        
        const plugins = await window.datastar.loadPlugins(['anchor']);
        log(`‚úÖ Loaded ${plugins.length} plugins successfully!`, 'manual');
        updatePluginList();
        
      } catch (error) {
        log(`‚ùå Failed to load plugins: ${error.message}`, 'manual');
      }
    }

    async function autoLoadPlugins() {
      try {
        log('Auto-discovering required plugins...', 'manual');
        
        await window.datastar.autoLoadPlugins();
        log('‚úÖ Auto-loading completed!', 'manual');
        updateIndicator('anchor-indicator', 'loaded');
        updatePluginList();
        
        // Mark auto-discovery demo as active
        document.getElementById('auto-discovery-demo').classList.add('active');
        
      } catch (error) {
        log(`‚ùå Auto-loading failed: ${error.message}`, 'manual');
      }
    }

    function unloadPlugin() {
      try {
        if (window.DatastarPluginLoader) {
          window.DatastarPluginLoader.unloadPlugin('anchor');
          log('üóëÔ∏è Anchor plugin unloaded', 'manual');
          updateIndicator('anchor-indicator', 'pending');
          updatePluginList();
        }
      } catch (error) {
        log(`‚ùå Failed to unload plugin: ${error.message}`, 'manual');
      }
    }

    function enableFunctionalityDemo() {
      // Set up hover interactions for demo buttons
      const buttons = ['demo-btn-1', 'demo-btn-2', 'demo-btn-3', 'demo-btn-4'];
      
      buttons.forEach((btnId, index) => {
        const btn = document.getElementById(btnId);
        const tooltipVar = `tooltip${index + 1}`;
        
        btn.addEventListener('mouseenter', () => {
          if (window.datastar && window.datastar.signals) {
            window.datastar.signals[`$${tooltipVar}`] = { value: true };
            log(`Showing ${tooltipVar}`);
          }
        });
        
        btn.addEventListener('mouseleave', () => {
          if (window.datastar && window.datastar.signals) {
            window.datastar.signals[`$${tooltipVar}`] = { value: false };
            log(`Hiding ${tooltipVar}`);
          }
        });
      });
    }

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', () => {
      log('DOM Content Loaded');
      
      // Check for Datastar
      const checkDatastar = setInterval(() => {
        if (window.datastar) {
          clearInterval(checkDatastar);
          log('‚úÖ Datastar found');
          updateIndicator('datastar-indicator', 'loaded');
          
          // Check for plugin loader
          if (window.DatastarPluginLoader) {
            log('‚úÖ Plugin Loader found');
            updateIndicator('loader-indicator', 'loaded');
            
            // Initialize demo signals
            window.datastar.signals = window.datastar.signals || {};
            window.datastar.signals.$showTooltip = { value: false };
            window.datastar.signals.$tooltip1 = { value: false };
            window.datastar.signals.$tooltip2 = { value: false };
            window.datastar.signals.$tooltip3 = { value: false };
            window.datastar.signals.$tooltip4 = { value: false };
            
            log('üéØ Ready for plugin loading tests!');
          } else {
            log('‚ùå Plugin Loader not found');
            updateIndicator('loader-indicator', 'error');
          }
        }
      }, 100);
      
      // Timeout after 5 seconds
      setTimeout(() => {
        clearInterval(checkDatastar);
        if (!window.datastar) {
          log('‚ùå Datastar not found after 5 seconds');
          updateIndicator('datastar-indicator', 'error');
        }
      }, 5000);
    });

    // Update plugin list periodically
    setInterval(updatePluginList, 2000);
  </script>
</body>
</html>